<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>乡村数字治理智慧平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft YaHei', 'Segoe UI', sans-serif;
        }
        
        body {
            background: #f5f5f5;
            color: #333;
            min-height: 100vh;
        }
        
        .dashboard-container {
            width: 100%;
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        /* 顶部导航栏 */
        .top-bar {
            background: linear-gradient(90deg, #2b6cb0 0%, #3182ce 100%);
            color: white;
            padding: 0 25px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        
        .logo-area {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo {
            font-size: 20px;
            font-weight: 600;
        }
        
        .alert-scroll {
            flex: 1;
            margin: 0 20px;
            overflow: hidden;
            position: relative;
            height: 24px;
            display: flex;
            align-items: center;
        }
        
        .alert-content {
            position: absolute;
            white-space: nowrap;
            animation: scrollText 15s linear infinite;
            font-size: 14px;
        }
        
        @keyframes scrollText {
            0% { transform: translateX(100%); }
            100% { transform: translateX(-100%); }
        }
        
        .alert-item {
            color: #ffeb3b;
            display: inline-block;
        }
        
        .alert-item i {
            margin-right: 8px;
        }
        
        .user-area {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-info {
            text-align: right;
        }
        
        .user-name {
            font-weight: 600;
            font-size: 16px;
        }
        
        .user-role {
            font-size: 12px;
            opacity: 0.9;
        }
        
        .message-badge {
            position: relative;
            font-size: 18px;
            cursor: pointer;
        }
        
        /* 主内容区域 */
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        
        /* 左侧导航栏 */
        .left-nav {
            width: 220px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            border-right: 1px solid #e0e0e0;
        }
        
        .nav-menu {
            flex: 1;
            padding: 20px 0;
        }
        
        .nav-item {
            display: flex;
            align-items: center;
            padding: 14px 20px;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 4px solid transparent;
            position: relative;
        }
        
        .nav-item:hover {
            background: #e9ecef;
        }
        
        .nav-item.active {
            background: #e3f2fd;
            border-left-color: #2196f3;
            color: #1976d2;
        }
        
        .nav-icon {
            width: 20px;
            text-align: center;
            margin-right: 12px;
            font-size: 16px;
            color: #666;
        }
        
        .nav-item.active .nav-icon {
            color: #1976d2;
        }
        
        .nav-text {
            flex: 1;
            font-size: 14px;
        }
        
        /* 右侧内容区域 */
        .right-content {
            flex: 1;
            padding: 25px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            overflow-y: auto;
        }
        
        /* 模块内容区域 */
        .module-content {
            display: none;
            flex-direction: column;
            gap: 20px;
        }
        
        .module-content.active {
            display: flex;
        }
        
        .module-header {
            font-size: 24px;
            color: #2d3748;
            margin-bottom: 10px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e2e8f0;
            font-weight: 600;
        }
        
        .module-description {
            color: #4a5568;
            margin-bottom: 20px;
            line-height: 1.6;
        }
        
        /* 子功能区域 */
        .sub-modules {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .sub-module {
            flex: 1;
            min-width: 300px;
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            border: 1px solid #e0e0e0;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .sub-module:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .sub-module-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .sub-module-icon {
            width: 40px;
            height: 40px;
            background: #2196f3;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-size: 18px;
        }
        
        .sub-module-title {
            font-size: 18px;
            font-weight: 600;
            color: #2d3748;
        }
        
        .sub-module-description {
            color: #4a5568;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .sub-module-features {
            list-style: none;
            margin-bottom: 15px;
        }
        
        .sub-module-features li {
            padding: 5px 0;
            color: #555;
            display: flex;
            align-items: center;
        }
        
        .sub-module-features li:before {
            content: "•";
            color: #2196f3;
            font-weight: bold;
            margin-right: 10px;
        }
        
        .sub-module-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.2s;
        }
        
        .btn-primary {
            background: #2196f3;
            color: white;
        }
        
        .btn-primary:hover {
            background: #1976d2;
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
        }
        
        .btn-secondary:hover {
            background: #bdbdbd;
        }
        
        /* 数据表格区域 */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .data-table th {
            background: #f1f5f9;
            padding: 12px 15px;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 1px solid #e2e8f0;
        }
        
        .data-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #e2e8f0;
            color: #4a5568;
        }
        
        .data-table tr:hover {
            background: #f7fafc;
        }
        
        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-pending {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-completed {
            background: #d1ecf1;
            color: #0c5460;
        }
        
        .status-warning {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* 底部状态栏 */
        .bottom-bar {
            background: #f8f9fa;
            padding: 10px 25px;
            border-top: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .time-weather {
            display: flex;
            align-items: center;
            gap: 15px;
            color: #666;
        }
        
        .weather {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        /* Modal */
        .village-modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.45);display:flex;align-items:center;justify-content:center;z-index:9999}
        .village-modal{background:white;width:90%;max-width:800px;border-radius:8px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.2);}
        .village-modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
        .village-modal-close{background:#eee;border:none;padding:6px 10px;border-radius:4px;cursor:pointer}
        /* Sub-panel */
        .sub-panel-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            max-width: 900px;
            max-height: 80vh;
            background: white;
            border-radius: 8px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            z-index: 1000;
            display: none;
            flex-direction: column;
        }
        .sub-panel-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid #e0e0e0;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
        }
        .sub-panel-header h3 { margin: 0; color: #2d3748; }
        .btn-close { background: none; border: none; font-size: 18px; cursor: pointer; color: #666; padding: 5px; }
        .btn-close:hover { color: #333; }
        .sub-panel-content { padding: 20px; overflow-y: auto; flex: 1; }
        .sub-panel-section { margin-bottom: 20px; }
        .sub-panel-section h4 { margin-bottom: 15px; color: #2d3748; border-bottom: 1px solid #e0e0e0; padding-bottom: 10px; }
        .search-bar, .filter-bar {
            display: flex; gap: 10px; margin-bottom: 15px; align-items: center;
        }
        .search-bar input, .filter-bar input, .filter-bar select {
            padding: 8px; border: 1px solid #ddd; border-radius: 4px; flex: 1;
        }
        .task-form .form-group { margin-bottom: 15px; }
        .task-form label { display: block; margin-bottom: 5px; font-weight: 600; color: #4a5568; }
        .task-form input, .task-form textarea, .task-form select { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .task-form textarea { height: 100px; resize: vertical; }
        .form-actions { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
            z-index: 999; display: none;
        }
        /* Login page */
        .login-page{min-height:100vh;display:flex;align-items:center;justify-content:center;background:#f5f7fb;}
        .login-box{background:#fff;width:360px;border-radius:8px;padding:20px;box-shadow:0 6px 20px rgba(0,0,0,0.2);}
        .login-box h3{margin-bottom:12px;color:#2d3748;}
        .login-box .form-group{margin-bottom:12px;}
        .login-box label{display:block;margin-bottom:6px;font-weight:600;color:#4a5568;}
        .login-box input{width:100%;padding:8px;border:1px solid #ddd;border-radius:4px;}
    </style>
</head>
<body>
    <div id="login-page" class="login-page">
        <div class="login-box">
            <h3>管理员登录</h3>
            <form id="login-form">
                <div class="form-group">
                    <label>账号</label>
                    <input name="username" type="text" placeholder="admin" required>
                </div>
                <div class="form-group">
                    <label>密码</label>
                    <input name="password" type="password" placeholder="123456" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">登录</button>
                </div>
                <div id="login-error" class="muted" style="margin-top:8px;color:#d32f2f;"></div>
            </form>
        </div>
    </div>

    <div id="app-page" class="dashboard-container" style="display:none;">
        <!-- 顶部导航栏 -->
        <div class="top-bar">
            <div class="logo-area">
                <div class="logo">乡村数字治理智慧平台</div>
            </div>
            <div class="alert-scroll">
                <div class="alert-content">
                    <span class="alert-item"><i class="fas fa-exclamation-triangle"></i></span>
                </div>
            </div>
            <div class="user-area" id="user-area" style="cursor:pointer;">
                <div class="user-info">
                    <div class="user-name">-</div>
                    <div class="user-role">-</div>
                </div>
                <div class="message-badge">
                    <i class="fas fa-bell"></i>
                </div>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 左侧导航栏 -->
            <div class="left-nav">
                <div class="nav-menu">
                    <div class="nav-item active" data-module="dashboard">
                        <div class="nav-icon"><i class="fas fa-tachometer-alt"></i></div>
                        <div class="nav-text">首页看板</div>
                    </div>
                    
                    <div class="nav-item" data-module="user">
                        <div class="nav-icon"><i class="fas fa-users"></i></div>
                        <div class="nav-text">用户与权限管理</div>
                    </div>
                    
                    <div class="nav-item" data-module="finance">
                        <div class="nav-icon"><i class="fas fa-money-bill-wave"></i></div>
                        <div class="nav-text">财务与收支管理</div>
                    </div>
                    
                    <div class="nav-item" data-module="warning">
                        <div class="nav-icon"><i class="fas fa-exclamation-triangle"></i></div>
                        <div class="nav-text">预警管理</div>
                    </div>
                    
                    <div class="nav-item" data-module="governance">
                        <div class="nav-icon"><i class="fas fa-tasks"></i></div>
                        <div class="nav-text">基层治理与任务</div>
                    </div>
                    
                    <div class="nav-item" data-module="feedback">
                        <div class="nav-icon"><i class="fas fa-comments"></i></div>
                        <div class="nav-text">民情反馈与政务公开</div>
                    </div>
                    
                    <div class="nav-item" data-module="industry">
                        <div class="nav-icon"><i class="fas fa-industry"></i></div>
                        <div class="nav-text">产业看板模块</div>
                    </div>
                    
                    <div class="nav-item" data-module="ai">
                        <div class="nav-icon"><i class="fas fa-robot"></i></div>
                        <div class="nav-text">AI 辅助模块</div>
                    </div>
                    
                    <div class="nav-item" data-module="ops">
                        <div class="nav-icon"><i class="fas fa-shield-alt"></i></div>
                        <div class="nav-text">运维与审计模块</div>
                    </div>
                </div>
            </div>

            <!-- 右侧内容区域 -->
            <div class="right-content">
                <!-- 首页看板模块 -->
                <div class="module-content active" id="dashboard">
                    <div class="module-header">首页看板</div>
                    <div class="module-description">系统概览和核心数据指标展示</div>
                    
                    <div class="sub-modules">
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="sub-module-title">数据概览</div>
                            </div>
                            <div class="sub-module-description">
                                展示关键指标和系统运行状态
                            </div>
                            <ul class="sub-module-features">
                                <li>今日申报：24项</li>
                                <li>待处理预警：3条</li>
                                <li>积分待审核：12项</li>
                                <li>反馈未回复：5条</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-open="finance" data-panel="dashboard-overview">查看详情</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div class="sub-module-title">预警中心</div>
                            </div>
                            <div class="sub-module-description">
                                实时监控和预警信息展示
                            </div>
                            <ul class="sub-module-features">
                                <li>森林防火预警：1条</li>
                                <li>气象预警：2条</li>
                                <li>设备异常：0条</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-open="warning" data-panel="warning-handle">处理预警</button>
                                <button class="btn btn-secondary" data-open="warning" data-panel="warning-settings">预警设置</button>
                            </div>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>事件类型</th>
                                <th>描述</th>
                                <th>状态</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>2024-01-29 14:30</td>
                                <td>预警信息</td>
                                <td>后山区域温度异常升高</td>
                                <td><span class="status-badge status-warning">待处理</span></td>
                                <td><button class="btn btn-primary">查看</button></td>
                            </tr>
                            <tr>
                                <td>2024-01-29 13:45</td>
                                <td>村民反馈</td>
                                <td>道路损坏需要维修</td>
                                <td><span class="status-badge status-pending">处理中</span></td>
                                <td><button class="btn btn-primary">处理</button></td>
                            </tr>
                            <tr>
                                <td>2024-01-29 10:20</td>
                                <td>任务完成</td>
                                <td>春季植树活动已完成</td>
                                <td><span class="status-badge status-completed">已完成</span></td>
                                <td><button class="btn btn-secondary">详情</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
                <!-- 用户与权限管理模块 -->
                <div class="module-content" id="user">
                    <div class="module-header">用户与权限管理</div>
                    <div class="module-description">用户身份管理、角色与权限控制、村民基础信息管理</div>
                    
                    <div class="sub-modules">
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-user-shield"></i>
                                </div>
                                <div class="sub-module-title">认证与登录</div>
                            </div>
                            <div class="sub-module-description">
                                用户登录、单点登录和身份验证管理
                            </div>
                            <ul class="sub-module-features">
                                <li>支持多因素认证</li>
                                <li>登录日志记录</li>
                                <li>会话管理</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-open="user" data-panel="user-login-settings">登录设置</button>
                                <button class="btn btn-secondary" data-open="user" data-panel="user-login-logs">日志查看</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-users-cog"></i>
                                </div>
                                <div class="sub-module-title">角色权限管理</div>
                            </div>
                            <div class="sub-module-description">
                                基于RBAC的细粒度权限控制
                            </div>
                            <ul class="sub-module-features">
                                <li>角色定义与分配</li>
                                <li>权限组管理</li>
                                <li>数据权限控制</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-open="user" data-panel="user-roles">角色管理</button>
                                <button class="btn btn-secondary" data-open="user" data-panel="user-permissions">权限设置</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-address-card"></i>
                                </div>
                                <div class="sub-module-title">居民信息管理</div>
                            </div>
                            <div class="sub-module-description">
                                村民基础信息、证件/ID卡管理
                            </div>
                            <ul class="sub-module-features">
                                <li>居民信息台账</li>
                                <li>家庭关系管理</li>
                                <li>证件照上传</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-open="user" data-panel="user-residents">居民列表</button>
                                <button class="btn btn-secondary" data-open="user" data-panel="user-import">信息导入</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 财务与收支管理模块 -->
                <div class="module-content" id="finance">
                    <div class="module-header">财务与收支管理</div>
                    <div class="module-description">收支凭证录入、审核流程、对账与报表、预算与项目资金管理</div>
                    
                    <div class="sub-modules">
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-receipt"></i>
                                </div>
                                <div class="sub-module-title">收支录入</div>
                            </div>
                            <div class="sub-module-description">
                                收支凭证录入和附件管理
                            </div>
                            <ul class="sub-module-features">
                                <li>多类型收支记录</li>
                                <li>凭证附件上传</li>
                                <li>自动编号生成</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-open="finance" data-panel="finance-add">新增记录</button>
                                <button class="btn btn-secondary" data-open="finance" data-panel="finance-import">批量导入</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-check-double"></i>
                                </div>
                                <div class="sub-module-title">审核工作流</div>
                            </div>
                            <div class="sub-module-description">
                                多级审核流程和审批记录
                            </div>
                            <ul class="sub-module-features">
                                <li>可配置审核流程</li>
                                <li>审批历史追踪</li>
                                <li>退回重审功能</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-open="finance" data-panel="finance-approve-list">待审核列表</button>
                                <button class="btn btn-secondary" data-open="finance" data-panel="finance-flow-settings">流程设置</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-chart-pie"></i>
                                </div>
                                <div class="sub-module-title">报表与分析</div>
                            </div>
                            <div class="sub-module-description">
                                财务报表生成和数据分析
                            </div>
                            <ul class="sub-module-features">
                                <li>月度/年度报表</li>
                                <li>多格式导出(CSV/PDF)</li>
                                <li>可视化图表分析</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-open="finance" data-panel="finance-report">生成报表</button>
                                <button class="btn btn-secondary" data-open="finance" data-panel="finance-analysis">数据分析</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 预警管理模块 -->
                <div class="module-content" id="warning">
                    <div class="module-header">预警管理</div>
                    <div class="module-description">定义预警规则、实时检测、自动分派与通知、预警处置记录</div>
                    
                    <div class="sub-modules">
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-cogs"></i>
                                </div>
                                <div class="sub-module-title">规则引擎配置</div>
                            </div>
                            <div class="sub-module-description">
                                预警规则定义和条件设置
                            </div>
                            <ul class="sub-module-features">
                                <li>多条件规则配置</li>
                                <li>阈值设置与管理</li>
                                <li>规则测试与验证</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-open="warning" data-panel="warning-rules">规则管理</button>
                                <button class="btn btn-secondary" data-open="warning" data-panel="warning-rules-create">新建规则</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-bell"></i>
                                </div>
                                <div class="sub-module-title">实时预警监控</div>
                            </div>
                            <div class="sub-module-description">
                                实时检测和预警信息展示
                            </div>
                            <ul class="sub-module-features">
                                <li>实时数据监控</li>
                                <li>预警触发记录</li>
                                <li>严重程度分级</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-open="warning" data-panel="warning-monitor">监控面板</button>
                                <button class="btn btn-secondary" data-open="warning" data-panel="warning-list">预警列表</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-user-check"></i>
                                </div>
                                <div class="sub-module-title">分派与通知</div>
                            </div>
                            <div class="sub-module-description">
                                预警自动分派和通知管理
                            </div>
                            <ul class="sub-module-features">
                                <li>自动分派策略</li>
                                <li>多通道通知(短信/邮件)</li>
                                <li>分派记录追踪</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-open="warning" data-panel="warning-assign">分派设置</button>
                                <button class="btn btn-secondary" data-open="warning" data-panel="warning-notify-log">通知记录</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-history"></i>
                                </div>
                                <div class="sub-module-title">处置记录与追踪</div>
                            </div>
                            <div class="sub-module-description">
                                预警处置过程和结果记录
                            </div>
                            <ul class="sub-module-features">
                                <li>处置流程记录</li>
                                <li>处理结果反馈</li>
                                <li>历史数据查询</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-open="warning" data-panel="warning-handle-log">处置记录</button>
                                <button class="btn btn-secondary" data-open="warning" data-panel="warning-stats">统计分析</button>
                            </div>
                        </div>
                    </div>
                    
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>预警时间</th>
                                <th>预警类型</th>
                                <th>严重程度</th>
                                <th>触发规则</th>
                                <th>处置状态</th>
                                <th>负责人</th>
                                <th>操作</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr>
                                <td>2024-01-29 14:30</td>
                                <td>森林防火</td>
                                <td><span class="status-badge status-warning">高危</span></td>
                                <td>温度异常升高</td>
                                <td><span class="status-badge status-pending">处置中</span></td>
                                <td>文霞</td>
                                <td><button class="btn btn-primary">处理</button></td>
                            </tr>
                            <tr>
                                <td>2024-01-29 13:15</td>
                                <td>气象预警</td>
                                <td><span class="status-badge status-warning">中危</span></td>
                                <td>大风橙色预警</td>
                                <td><span class="status-badge status-completed">已处理</span></td>
                                <td>李慧颖</td>
                                <td><button class="btn btn-secondary">详情</button></td>
                            </tr>
                        </tbody>
                    </table>
                </div>        
                
                <!-- 基层治理与任务模块 -->
                <div class="module-content" id="governance">
                    <div class="module-header">基层治理与任务</div>
                    <div class="module-description">发布治理任务、签到/验收、积分规则与申报、活动管理</div>
                    
                    <div class="sub-modules">
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-tasks"></i>
                                </div>
                                <div class="sub-module-title">任务发布与管理</div>
                            </div>
                            <div class="sub-module-description">
                                治理任务创建、分配和跟踪
                            </div>
                            <ul class="sub-module-features">
                                <li>任务模板管理</li>
                                <li>自动分配机制</li>
                                <li>进度实时跟踪</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-panel="gov-task-list">任务列表</button>
                                <button class="btn btn-secondary" data-panel="gov-task-publish">发布任务</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-check-circle"></i>
                                </div>
                                <div class="sub-module-title">签到与验收</div>
                            </div>
                            <div class="sub-module-description">
                                任务执行签到和成果验收
                            </div>
                            <ul class="sub-module-features">
                                <li>地理位置签到</li>
                                <li>照片证据上传</li>
                                <li>多级验收流程</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-panel="gov-checkin-record">签到记录</button>
                                <button class="btn btn-secondary" data-panel="gov-acceptance">验收管理</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-star"></i>
                                </div>
                                <div class="sub-module-title">积分规则管理</div>
                            </div>
                            <div class="sub-module-description">
                                积分规则设置和申报管理
                            </div>
                            <ul class="sub-module-features">
                                <li>积分标准配置</li>
                                <li>自动积分计算</li>
                                <li>申报审核流程</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-panel="gov-point-rules">积分规则</button>
                                <button class="btn btn-secondary" data-panel="gov-point-audit">申报审核</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="sub-module-title">活动管理</div>
                            </div>
                            <div class="sub-module-description">
                                村级活动组织和参与管理
                            </div>
                            <ul class="sub-module-features">
                                <li>活动发布报名</li>
                                <li>参与情况统计</li>
                                <li>活动效果评估</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-panel="gov-activity-list">活动列表</button>
                                <button class="btn btn-secondary" data-panel="gov-activity-create">新建活动</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 民情反馈与政务公开模块 -->
                <div class="module-content" id="feedback">
                    <div class="module-header">民情反馈与政务公开</div>
                    <div class="module-description">收集民情、受理与流转、回应公开与统计、政务信息发布</div>
                    
                    <div class="sub-modules">
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-inbox"></i>
                                </div>
                                <div class="sub-module-title">反馈受理台</div>
                            </div>
                            <div class="sub-module-description">
                                多渠道反馈信息收集和受理
                            </div>
                            <ul class="sub-module-features">
                                <li>多渠道接入(APP/来访/电话)</li>
                                <li>自动分类标签</li>
                                <li>紧急程度分级</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-panel="feedback-pending">待处理反馈</button>
                                <button class="btn btn-secondary" data-panel="feedback-stats">反馈统计</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                                <div class="sub-module-title">流转与处理</div>
                            </div>
                            <div class="sub-module-description">
                                反馈信息流转和处理流程管理
                            </div>
                            <ul class="sub-module-features">
                                <li>自动分派规则</li>
                                <li>处理时限监控</li>
                                <li>流程节点追踪</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-panel="feedback-processing">处理中事项</button>
                                <button class="btn btn-secondary" data-panel="feedback-flow">流程设置</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-bullhorn"></i>
                                </div>
                                <div class="sub-module-title">政务公开</div>
                            </div>
                            <div class="sub-module-description">
                                政务信息发布和公开管理
                            </div>
                            <ul class="sub-module-features">
                                <li>信息发布审核</li>
                                <li>公开范围控制</li>
                                <li>阅读统计</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-panel="feedback-publish">发布管理</button>
                                <button class="btn btn-secondary" data-panel="feedback-create">新建公告</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-chart-bar"></i>
                                </div>
                                <div class="sub-module-title">互动统计</div>
                            </div>
                            <div class="sub-module-description">
                                反馈处理和互动数据分析
                            </div>
                            <ul class="sub-module-features">
                                <li>满意度统计</li>
                                <li>处理效率分析</li>
                                <li>热点问题识别</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-panel="feedback-report">统计报表</button>
                                <button class="btn btn-secondary" data-panel="feedback-analysis">数据分析</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 产业看板模块 -->
                <div class="module-content" id="industry">
                    <div class="module-header">产业看板模块</div>
                    <div class="module-description">产业数据采集、关键指标展示、趋势分析、产业预警与建议</div>
                    
                    <div class="sub-modules">
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-map-marked-alt"></i>
                                </div>
                                <div class="sub-module-title">基地管理</div>
                            </div>
                            <div class="sub-module-description">
                                产业基地信息和管理
                            </div>
                            <ul class="sub-module-features">
                                <li>基地基本信息管理</li>
                                <li>地理信息标注</li>
                                <li>生产基地关系</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-panel="industry-base-list">基地列表</button>
                                <button class="btn btn-secondary" data-panel="industry-map">地图视图</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-database"></i>
                                </div>
                                <div class="sub-module-title">数据采集器</div>
                            </div>
                            <div class="sub-module-description">
                                产业数据采集和指标管理
                            </div>
                            <ul class="sub-module-features">
                                <li>多源数据接入</li>
                                <li>指标定义管理</li>
                                <li>数据质量监控</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-panel="industry-sources">数据源管理</button>
                                <button class="btn btn-secondary" data-panel="industry-collect">采集任务</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-chart-line"></i>
                                </div>
                                <div class="sub-module-title">可视化面板</div>
                            </div>
                            <div class="sub-module-description">
                                产业数据可视化展示和分析
                            </div>
                            <ul class="sub-module-features">
                                <li>多维度图表展示</li>
                                <li>实时数据刷新</li>
                                <li>自定义看板</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-panel="industry-dashboard">产业大屏</button>
                                <button class="btn btn-secondary" data-panel="industry-charts">图表配置</button>
                            </div>
                        </div>
                        
                        <div class="sub-module">
                            <div class="sub-module-header">
                                <div class="sub-module-icon">
                                    <i class="fas fa-robot"></i>
                                </div>
                                <div class="sub-module-title">预测分析</div>
                            </div>
                            <div class="sub-module-description">
                                产业趋势预测和智能建议
                            </div>
                            <ul class="sub-module-features">
                                <li>趋势预测模型</li>
                                <li>风险预警提示</li>
                                <li>优化建议生成</li>
                            </ul>
                            <div class="sub-module-actions">
                                <button class="btn btn-primary" data-panel="industry-forecast">预测分析</button>
                                <button class="btn btn-secondary" data-panel="industry-models">模型管理</button>
                            </div>
                        </div>
                    </div>
                </div>

                                <!-- AI辅助模块 -->
                                <div class="module-content" id="ai">
                                    <div class="module-header">AI辅助模块</div>
                                    <div class="module-description">政策问答、自动摘要、智能建议、文本分类</div>
                    
                                    <div class="sub-modules">
                                        <div class="sub-module">
                                            <div class="sub-module-header">
                                                <div class="sub-module-icon">
                                                    <i class="fas fa-question-circle"></i>
                                                </div>
                                                <div class="sub-module-title">智能问答</div>
                                            </div>
                                            <div class="sub-module-description">
                                                政策法规智能问答服务
                                            </div>
                                            <ul class="sub-module-features">
                                                <li>自然语言理解</li>
                                                <li>政策精准匹配</li>
                                                <li>多轮对话支持</li>
                                            </ul>
                                            <div class="sub-module-actions">
                                                <button class="btn btn-primary" data-panel="ai-qa">开始问答</button>
                                                <button class="btn btn-secondary" data-panel="ai-qa-log">问答记录</button>
                                            </div>
                                        </div>
                        
                                        <div class="sub-module">
                                            <div class="sub-module-header">
                                                <div class="sub-module-icon">
                                                    <i class="fas fa-file-contract"></i>
                                                </div>
                                                <div class="sub-module-title">自动摘要</div>
                                            </div>
                                            <div class="sub-module-description">
                                                文档自动摘要和报告生成
                                            </div>
                                            <ul class="sub-module-features">
                                                <li>多文档摘要</li>
                                                <li>关键信息提取</li>
                                                <li>报告模板生成</li>
                                            </ul>
                                            <div class="sub-module-actions">
                                                <button class="btn btn-primary" data-panel="ai-doc">文档处理</button>
                                            </div>
                                        </div>
                        
                                        <div class="sub-module">
                                            <div class="sub-module-header">
                                                <div class="sub-module-icon">
                                                    <i class="fas fa-lightbulb"></i>
                                                </div>
                                                <div class="sub-module-title">智能建议</div>
                                            </div>
                                            <div class="sub-module-description">
                                                基于数据的智能决策建议
                                            </div>
                                            <ul class="sub-module-features">
                                                <li>数据驱动建议</li>
                                                <li>多方案对比</li>
                                                <li>风险评估</li>
                                            </ul>
                                            <div class="sub-module-actions">
                                                <button class="btn btn-primary" data-panel="ai-advice">获取建议</button>
                                                <button class="btn btn-secondary" data-panel="ai-advice-log">建议历史</button>
                                            </div>
                                        </div>
                        
                                        <div class="sub-module">
                                            <div class="sub-module-header">
                                                <div class="sub-module-icon">
                                                    <i class="fas fa-cog"></i>
                                                </div>
                                                <div class="sub-module-title">模型管理</div>
                                            </div>
                                            <div class="sub-module-description">
                                                AI模型配置和管理(管理员)
                                            </div>
                                            <ul class="sub-module-features">
                                                <li>模型版本管理</li>
                                                <li>性能监控</li>
                                                <li>调用审计</li>
                                            </ul>
                                            <div class="sub-module-actions">
                                                <button class="btn btn-secondary" data-panel="ai-monitor">监控面板</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- 运维与审计模块 -->
                                <div class="module-content" id="ops">
                                    <div class="module-header">运维与审计模块</div>
                                    <div class="module-description">系统监控、日志管理、备份/恢复、数据清理、审计链路</div>
                    
                                    <div class="sub-modules">
                                        <div class="sub-module">
                                            <div class="sub-module-header">
                                                <div class="sub-module-icon">
                                                    <i class="fas fa-heartbeat"></i>
                                                </div>
                                                <div class="sub-module-title">系统监控</div>
                                            </div>
                                            <div class="sub-module-description">
                                                系统运行状态监控和健康检查
                                            </div>
                                            <ul class="sub-module-features">
                                                <li>服务状态监控</li>
                                                <li>性能指标采集</li>
                                                <li>告警阈值设置</li>
                                            </ul>
                                            <div class="sub-module-actions">
                                                <button class="btn btn-primary" data-panel="ops-monitor">监控面板</button>
                                                <button class="btn btn-secondary" data-panel="ops-health">健康检查</button>
                                            </div>
                                        </div>
                        
                                        <div class="sub-module">
                                            <div class="sub-module-header">
                                                <div class="sub-module-icon">
                                                    <i class="fas fa-clipboard-list"></i>
                                                </div>
                                                <div class="sub-module-title">日志中心</div>
                                            </div>
                                            <div class="sub-module-description">
                                                系统操作日志和审计日志管理
                                            </div>
                                            <ul class="sub-module-features">
                                                <li>日志分类存储</li>
                                                <li>高级查询功能</li>
                                                <li>日志分析报告</li>
                                            </ul>
                                            <div class="sub-module-actions">
                                                <button class="btn btn-primary" data-panel="ops-log-search">日志查询</button>
                                                <button class="btn btn-secondary" data-panel="ops-log-report">分析报告</button>
                                            </div>
                                        </div>
                        
                                        <div class="sub-module">
                                            <div class="sub-module-header">
                                                <div class="sub-module-icon">
                                                    <i class="fas fa-download"></i>
                                                </div>
                                                <div class="sub-module-title">备份与恢复</div>
                                            </div>
                                            <div class="sub-module-description">
                                                数据备份策略和恢复操作
                                            </div>
                                            <ul class="sub-module-features">
                                                <li>自动备份计划</li>
                                                <li>增量备份支持</li>
                                                <li>一键恢复操作</li>
                                            </ul>
                                            <div class="sub-module-actions">
                                                <button class="btn btn-primary" data-panel="ops-backup">备份任务</button>
                                                <button class="btn btn-secondary" data-panel="ops-restore">恢复操作</button>
                                            </div>
                                        </div>
                        
                                        <div class="sub-module">
                                            <div class="sub-module-header">
                                                <div class="sub-module-icon">
                                                    <i class="fas fa-user-shield"></i>
                                                </div>
                                                <div class="sub-module-title">权限审计</div>
                                            </div>
                                            <div class="sub-module-description">
                                                用户操作审计和权限变更追踪
                                            </div>
                                            <ul class="sub-module-features">
                                                <li>敏感操作审计</li>
                                                <li>权限变更追踪</li>
                                                <li>合规性报告</li>
                                            </ul>
                                            <div class="sub-module-actions">
                                                <button class="btn btn-primary" data-panel="ops-audit-search">审计查询</button>
                                                <button class="btn btn-secondary" data-panel="ops-audit-report">合规报告</button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                
            </div>
        </div>

        <!-- 子面板遮罩与容器 -->
        <div id="sub-panel-overlay" class="overlay"></div>
        <div id="sub-panel-container" class="sub-panel-container">
            <div class="sub-panel-header">
                <h3 id="sub-panel-title">子面板标题</h3>
                <button class="btn btn-close" id="sub-panel-close">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sub-panel-content" id="sub-panel-content"></div>
        </div>

        <!-- 底部状态栏 -->
        <div class="bottom-bar">
            <div class="time-weather">
                <div class="weather">
                    <i class="fas fa-sun"></i>
                    <span>25°C</span>
                </div>
                <div id="currentTime">14:30:45</div>
            </div>
        </div>
    </div>

    <script>
        // 导航项点击效果
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', function() {
                // 移除所有active类
                document.querySelectorAll('.nav-item').forEach(i => {
                    i.classList.remove('active');
                });
                // 为当前项添加active类
                this.classList.add('active');
                
                // 隐藏所有模块内容
                document.querySelectorAll('.module-content').forEach(content => {
                    content.classList.remove('active');
                });
                
                // 显示对应的模块内容
                const moduleId = this.getAttribute('data-module');
                document.getElementById(moduleId).classList.add('active');
            });
        });
        
        // 登录逻辑
        const loginPage = document.getElementById('login-page');
        const appPage = document.getElementById('app-page');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const userNameEl = document.querySelector('.user-name');
        const userRoleEl = document.querySelector('.user-role');
        const userAreaEl = document.getElementById('user-area');

        async function doLogin(username, password){
            loginError.textContent = '';
            try{
                const r = await fetch(API_BASE + '/api/auth/login', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({username, password})});
                if(!r.ok){
                    const msg = await r.text();
                    throw new Error(msg || '登录失败');
                }
                const data = await r.json();
                localStorage.setItem('token', data.token || '');
                localStorage.setItem('userName', data.user?.name || '');
                localStorage.setItem('userRole', data.user?.role || '');
                localStorage.setItem('userUsername', data.user?.username || username);
                userNameEl.textContent = data.user?.name || username;
                userRoleEl.textContent = data.user?.role || '';
                loginPage.style.display = 'none';
                appPage.style.display = 'flex';
            }catch(err){
                loginError.textContent = '登录失败，请检查账号或密码';
            }
        }

        loginForm.addEventListener('submit', (e)=>{
            e.preventDefault();
            doLogin(loginForm.username.value, loginForm.password.value);
        });

        // 持久化登录状态
        const savedToken = localStorage.getItem('token');
        const savedName = localStorage.getItem('userName');
        const savedRole = localStorage.getItem('userRole');
        if(savedToken){
            if(savedName) userNameEl.textContent = savedName;
            if(savedRole) userRoleEl.textContent = savedRole;
            localStorage.setItem('userUsername', localStorage.getItem('userUsername') || 'admin');
            loginPage.style.display = 'none';
            appPage.style.display = 'flex';
        }else{
            loginPage.style.display = 'flex';
            appPage.style.display = 'none';
        }

        function showProfilePanel(){
            const title = '个人中心';
            document.getElementById('sub-panel-title').textContent = title;
            const name = localStorage.getItem('userName') || '文磊';
            const role = localStorage.getItem('userRole') || '管理员';
            const username = localStorage.getItem('userUsername') || 'admin';
            const phone = localStorage.getItem('userPhone') || '';
            document.getElementById('sub-panel-content').innerHTML = `
                <div class="sub-panel-section">
                    <h4>个人信息展示与编辑</h4>
                    <form class="task-form" id="profile-form">
                        <div class="form-group"><label>姓名</label><input name="name" type="text" value="${name}" required></div>
                        <div class="form-group"><label>用户名</label><input name="username" type="text" value="${username}" required></div>
                        <div class="form-group"><label>手机号</label><input name="phone" type="text" value="${phone}" placeholder="请输入手机号"></div>
                        <div class="form-group"><label>角色信息</label><input name="role" type="text" value="${role}" readonly></div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">保存</button>
                        </div>
                    </form>
                </div>
                <div class="sub-panel-section">
                    <h4>安全设置 / 密码修改</h4>
                    <form class="task-form" id="password-form">
                        <div class="form-group"><label>旧密码</label><input name="oldPassword" type="password" required></div>
                        <div class="form-group"><label>新密码</label><input name="newPassword" type="password" required></div>
                        <div class="form-group"><label>确认新密码</label><input name="confirmPassword" type="password" required></div>
                        <div class="form-actions">
                            <button type="submit" class="btn btn-primary">修改密码</button>
                        </div>
                    </form>
                </div>
                <div class="sub-panel-section">
                    <h4>登录记录查看</h4>
                    <table class="data-table" id="login-records-table">
                        <thead><tr><th>时间</th><th>IP</th><th>结果</th></tr></thead>
                        <tbody><tr><td>刚刚</td><td>127.0.0.1</td><td>成功</td></tr></tbody>
                    </table>
                </div>
                <div class="sub-panel-section">
                    <h4>账号操作</h4>
                    <div class="sub-module-actions">
                        <button class="btn btn-secondary" id="logout-btn">退出登录</button>
                        <button class="btn btn-primary" id="switch-btn">切换账号</button>
                    </div>
                </div>
            `;
            const profileForm = document.getElementById('profile-form');
            profileForm.addEventListener('submit', (e)=>{
                e.preventDefault();
                localStorage.setItem('userName', profileForm.name.value);
                localStorage.setItem('userRole', profileForm.role.value);
                localStorage.setItem('userPhone', profileForm.phone.value);
                localStorage.setItem('userUsername', profileForm.username.value);
                userNameEl.textContent = profileForm.name.value;
                userRoleEl.textContent = profileForm.role.value;
                alert('已保存');
            });
            const passwordForm = document.getElementById('password-form');
            passwordForm.addEventListener('submit', (e)=>{
                e.preventDefault();
                if(passwordForm.newPassword.value !== passwordForm.confirmPassword.value){
                    alert('两次输入的密码不一致');
                    return;
                }
                const payload = {
                    username: profileForm.username.value,
                    oldPassword: passwordForm.oldPassword.value,
                    newPassword: passwordForm.newPassword.value
                };
                fetch(API_BASE + '/api/auth/password', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)})
                    .then(r=> r.ok ? r.json() : Promise.reject())
                    .then(()=>{ alert('密码修改成功'); })
                    .catch(()=>{ alert('密码修改失败'); });
            });
            document.getElementById('logout-btn').addEventListener('click', ()=>{
                localStorage.removeItem('token');
                localStorage.removeItem('userName');
                localStorage.removeItem('userRole');
                localStorage.removeItem('userPhone');
                localStorage.removeItem('userUsername');
                loginPage.style.display = 'flex';
                appPage.style.display = 'none';
                hideSubPanel();
            });
            document.getElementById('switch-btn').addEventListener('click', ()=>{
                localStorage.removeItem('token');
                localStorage.removeItem('userUsername');
                loginPage.style.display = 'flex';
                appPage.style.display = 'none';
                hideSubPanel();
            });
            document.getElementById('sub-panel-container').style.display = 'flex';
            document.getElementById('sub-panel-overlay').style.display = 'block';
        }

        userAreaEl.addEventListener('click', showProfilePanel);

        // 更新时间
        function updateTime() {
            const now = new Date();
            const timeString = now.toTimeString().substring(0, 8);
            document.getElementById('currentTime').textContent = timeString;
        }

        // 子面板管理函数
        const API_BASE = 'http://localhost:8080';
        const panelTitles = {
            'dashboard-overview': '数据概览详情',
            'warning-handle': '预警处理',
            'warning-settings': '预警设置',
            'user-login-settings': '登录设置',
            'user-login-logs': '登录日志',
            'user-roles': '角色管理',
            'user-permissions': '权限设置',
            'user-residents': '居民列表',
            'user-import': '信息导入',
            'finance-add': '新增记录',
            'finance-import': '批量导入',
            'finance-approve-list': '待审核列表',
            'finance-flow-settings': '流程设置',
            'finance-report': '生成报表',
            'finance-analysis': '数据分析',
            'warning-rules': '规则管理',
            'warning-rules-create': '新建规则',
            'warning-monitor': '监控面板',
            'warning-list': '预警列表',
            'warning-assign': '分派设置',
            'warning-notify-log': '通知记录',
            'warning-handle-log': '处置记录',
            'warning-stats': '统计分析',
            'gov-task-list': '任务列表',
            'gov-task-publish': '发布任务',
            'gov-checkin-record': '签到记录',
            'gov-acceptance': '验收管理',
            'gov-point-rules': '积分规则',
            'gov-point-audit': '申报审核',
            'gov-activity-list': '活动列表',
            'gov-activity-create': '新建活动',
            'feedback-pending': '待处理反馈',
            'feedback-stats': '反馈统计',
            'feedback-processing': '处理中事项',
            'feedback-flow': '流程设置',
            'feedback-publish': '发布管理',
            'feedback-create': '新建公告',
            'feedback-report': '统计报表',
            'feedback-analysis': '数据分析',
            'industry-base-list': '基地列表',
            'industry-map': '地图视图',
            'industry-sources': '数据源管理',
            'industry-collect': '采集任务',
            'industry-dashboard': '产业大屏',
            'industry-charts': '图表配置',
            'industry-forecast': '预测分析',
            'industry-models': '模型管理',
            'ai-qa': '智能问答',
            'ai-qa-log': '问答记录',
            'ai-doc': '文档处理（自动摘要）',
            'ai-advice': '获取建议',
            'ai-advice-log': '建议历史',
            'ai-monitor': '监控面板',
            'ops-monitor': '系统监控',
            'ops-health': '健康检查',
            'ops-log-search': '日志查询',
            'ops-log-report': '分析报告',
            'ops-backup': '备份任务',
            'ops-restore': '恢复操作',
            'ops-audit-search': '审计查询',
            'ops-audit-report': '合规报告'
        };

        function buildPanelHtml(panelId, title){
            const isList = /(list|report|stats|log|monitor|dashboard|search|pending|processing|audit|record)/.test(panelId);
            const isForm = /(create|publish|settings|import|add|flow|rules|assign|analysis|restore|backup)/.test(panelId);
            if(panelId === 'user-residents'){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <form class="task-form" id="user-add-form">
                            <div class="form-group"><label>姓名</label><input name="name" type="text" placeholder="请输入姓名" required></div>
                            <div class="form-group"><label>角色</label><input name="role" type="text" placeholder="如：管理员"></div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">新增用户</button>
                                <button type="button" class="btn btn-secondary" onclick="hideSubPanel()">取消</button>
                            </div>
                        </form>
                        <table class="data-table">
                            <thead><tr><th>ID</th><th>姓名</th><th>角色</th><th>操作</th></tr></thead>
                            <tbody id="panel-users-body"><tr><td colspan="4">加载中...</td></tr></tbody>
                        </table>
                    </div>
                `;
            }
            if(panelId === 'user-import'){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <p class="muted">支持 CSV：每行格式为 姓名,角色（可选）。</p>
                        <form class="task-form" id="user-import-form">
                            <div class="form-group"><label>选择 CSV 文件</label><input name="file" type="file" accept=".csv" required></div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">导入</button>
                                <button type="button" class="btn btn-secondary" onclick="hideSubPanel()">取消</button>
                            </div>
                        </form>
                    </div>
                `;
            }
            if(panelId === 'user-roles' || panelId === 'user-permissions' || panelId === 'user-login-logs' || panelId === 'user-login-settings'){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <table class="data-table">
                            <thead><tr><th>ID</th><th>姓名</th><th>角色</th></tr></thead>
                            <tbody id="panel-users-body"><tr><td colspan="3">加载中...</td></tr></tbody>
                        </table>
                    </div>
                `;
            }
            if(panelId === 'finance-add'){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <form class="task-form" id="finance-add-form">
                            <div class="form-group"><label>说明</label><input name="desc" type="text" placeholder="请输入说明" required></div>
                            <div class="form-group"><label>金额</label><input name="amount" type="number" placeholder="请输入金额" required></div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">提交</button>
                                <button type="button" class="btn btn-secondary" onclick="hideSubPanel()">取消</button>
                            </div>
                        </form>
                    </div>
                `;
            }
            if(panelId === 'finance-report' || panelId === 'finance-approve-list' || panelId === 'finance-analysis' || panelId === 'finance-import' || panelId === 'finance-flow-settings'){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <table class="data-table">
                            <thead><tr><th>时间</th><th>说明</th><th>金额</th></tr></thead>
                            <tbody id="panel-finance-body"><tr><td colspan="3">加载中...</td></tr></tbody>
                        </table>
                    </div>
                `;
            }
            if(panelId === 'warning-list' || panelId === 'warning-handle-log' || panelId === 'warning-monitor' || panelId === 'warning-handle' || panelId === 'warning-stats' || panelId === 'warning-notify-log' || panelId === 'warning-assign'){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <table class="data-table">
                            <thead><tr><th>标题</th><th>说明</th><th>严重程度</th><th>状态</th></tr></thead>
                            <tbody id="panel-warning-body"><tr><td colspan="4">加载中...</td></tr></tbody>
                        </table>
                    </div>
                `;
            }
            if(panelId === 'warning-rules-create'){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <form class="task-form" id="warning-rule-form">
                            <div class="form-group"><label>规则名称</label><input name="rule" type="text" placeholder="请输入规则名称" required></div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">提交</button>
                                <button type="button" class="btn btn-secondary" onclick="hideSubPanel()">取消</button>
                            </div>
                        </form>
                    </div>
                `;
            }
            if(panelId.startsWith('industry-')){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <form class="task-form" id="industry-add-form">
                            <div class="form-group"><label>指标</label><input name="name" type="text" placeholder="请输入指标" required></div>
                            <div class="form-group"><label>数值</label><input name="value" type="number" placeholder="请输入数值" required></div>
                            <div class="form-group"><label>单位</label><input name="unit" type="text" placeholder="如：吨"></div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">新增指标</button>
                                <button type="button" class="btn btn-secondary" onclick="hideSubPanel()">取消</button>
                            </div>
                        </form>
                        <table class="data-table">
                            <thead><tr><th>指标</th><th>数值</th><th>单位</th><th>更新时间</th><th>操作</th></tr></thead>
                            <tbody id="panel-industry-body"><tr><td colspan="5">加载中...</td></tr></tbody>
                        </table>
                    </div>
                `;
            }
            if(panelId === 'ai-qa'){
                return `
                    <div class="sub-panel-section" style="height:520px;">
                        <h4>${title}</h4>
                        <div id="ai-chat" style="border:1px solid #e0e0e0;border-radius:6px;padding:12px;height:380px;overflow:auto;background:#fafafa"></div>
                        <form class="task-form" id="ai-chat-form" style="margin-top:12px;">
                            <div class="form-group"><label>输入</label><input name="question" type="text" placeholder="请输入问题" required></div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">发送</button>
                                <button type="button" class="btn btn-secondary" onclick="hideSubPanel()">关闭</button>
                            </div>
                        </form>
                    </div>
                `;
            }
            if(panelId === 'ai-doc'){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <form class="task-form" id="ai-summary-form">
                            <div class="form-group"><label>文档内容</label><textarea name="content" placeholder="粘贴文档内容" required></textarea></div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">生成摘要</button>
                                <button type="button" class="btn btn-secondary" onclick="hideSubPanel()">关闭</button>
                            </div>
                        </form>
                        <div id="ai-summary-result" class="card" style="margin-top:12px;display:none;"></div>
                    </div>
                `;
            }
            if(panelId === 'ai-advice'){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <div id="ai-advice-result" class="card" style="margin-top:8px;">加载中...</div>
                        <div class="sub-module-actions" style="margin-top:8px;">
                            <button class="btn btn-primary" id="ai-advice-save">保存建议历史</button>
                        </div>
                        <table class="data-table" style="margin-top:12px;">
                            <thead><tr><th>指标</th><th>数值</th><th>单位</th></tr></thead>
                            <tbody id="panel-ai-advice-body"><tr><td colspan="3">加载中...</td></tr></tbody>
                        </table>
                    </div>
                `;
            }
            if(panelId.startsWith('ai-')){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <table class="data-table">
                            <thead><tr><th>问题</th><th>回答</th><th>时间</th></tr></thead>
                            <tbody id="panel-ai-body"><tr><td colspan="3">加载中...</td></tr></tbody>
                        </table>
                    </div>
                `;
            }
            if(panelId.startsWith('ops-')){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <table class="data-table">
                            <thead><tr><th>动作</th><th>操作者</th><th>状态</th><th>时间</th></tr></thead>
                            <tbody id="panel-ops-body"><tr><td colspan="4">加载中...</td></tr></tbody>
                        </table>
                    </div>
                `;
            }
            if(isList){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <div class="search-bar">
                            <input type="text" placeholder="搜索关键词">
                            <button class="btn btn-primary">搜索</button>
                        </div>
                        <table class="data-table">
                            <thead><tr><th>名称</th><th>负责人</th><th>状态</th><th>操作</th></tr></thead>
                            <tbody>
                                <tr><td>示例项 A</td><td>张三</td><td><span class="status-badge status-pending">进行中</span></td><td><button class="btn btn-primary">查看</button></td></tr>
                                <tr><td>示例项 B</td><td>李四</td><td><span class="status-badge status-completed">已完成</span></td><td><button class="btn btn-secondary">详情</button></td></tr>
                            </tbody>
                        </table>
                    </div>
                `;
            }
            if(isForm){
                return `
                    <div class="sub-panel-section">
                        <h4>${title}</h4>
                        <form class="task-form">
                            <div class="form-group"><label>标题</label><input type="text" placeholder="请输入标题"></div>
                            <div class="form-group"><label>描述</label><textarea placeholder="请输入描述"></textarea></div>
                            <div class="form-actions">
                                <button type="submit" class="btn btn-primary">提交</button>
                                <button type="button" class="btn btn-secondary" onclick="hideSubPanel()">取消</button>
                            </div>
                        </form>
                    </div>
                `;
            }
            return `<div class="sub-panel-section"><h4>${title}</h4><p>该功能正在开发中...</p></div>`;
        }

        function showSubPanel(panelId){
            const container = document.getElementById('sub-panel-container');
            const overlay = document.getElementById('sub-panel-overlay');
            const title = panelTitles[panelId] || '子面板';
            document.getElementById('sub-panel-title').textContent = title;
            document.getElementById('sub-panel-content').innerHTML = buildPanelHtml(panelId, title);
            container.style.display = 'flex';
            overlay.style.display = 'block';
            loadPanelData(panelId);
        }

        function hideSubPanel(){
            document.getElementById('sub-panel-container').style.display = 'none';
            document.getElementById('sub-panel-overlay').style.display = 'none';
        }

        // 绑定子功能按钮
        document.querySelectorAll('button[data-panel]').forEach(btn => {
            btn.addEventListener('click', function(){
                showSubPanel(this.getAttribute('data-panel'));
            });
        });

        async function loadPanelData(panelId){
            if(panelId === 'user-residents'){
                try{
                    const r = await fetch(API_BASE + '/api/users', {cache:'no-store'});
                    const users = await r.json();
                    const tbody = document.getElementById('panel-users-body');
                    if(!tbody) return;
                    tbody.innerHTML = users.map(u=>`<tr><td>${u.id}</td><td>${u.name}</td><td>${u.role||'-'}</td><td><button class="btn btn-secondary" data-action="edit" data-id="${u.id}">编辑</button> <button class="btn btn-secondary" data-action="delete" data-id="${u.id}">删除</button></td></tr>`).join('');
                    const table = tbody.closest('table');
                    if(table && !table.dataset.bound){
                        table.dataset.bound = '1';
                        table.addEventListener('click', async (e)=>{
                            const btn = e.target.closest('button[data-action]');
                            if(!btn) return;
                            const id = btn.getAttribute('data-id');
                            const action = btn.getAttribute('data-action');
                            if(action === 'delete'){
                                if(!confirm('确认删除用户 ID='+id+' 吗？')) return;
                                const r = await fetch(API_BASE + '/api/users/' + id, {method:'DELETE'});
                                if(!r.ok){ alert('删除失败'); return; }
                                showSubPanel('user-residents');
                            }
                            if(action === 'edit'){
                                const name = prompt('请输入姓名', btn.closest('tr').children[1].textContent);
                                if(name===null) return;
                                const role = prompt('请输入角色', btn.closest('tr').children[2].textContent);
                                const payload = { name, role };
                                const r = await fetch(API_BASE + '/api/users/' + id, {method:'PUT', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
                                if(!r.ok){ alert('更新失败'); return; }
                                showSubPanel('user-residents');
                            }
                        });
                    }
                    const form = document.getElementById('user-add-form');
                    if(form && !form.dataset.bound){
                        form.dataset.bound = '1';
                        form.addEventListener('submit', async (e)=>{
                            e.preventDefault();
                            const payload = { name: form.name.value, role: form.role.value };
                            const r = await fetch(API_BASE + '/api/users', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
                            if(!r.ok){ alert('新增失败'); return; }
                            form.reset();
                            showSubPanel('user-residents');
                        });
                    }
                }catch(e){
                    const tbody = document.getElementById('panel-users-body');
                    if(tbody) tbody.innerHTML = '<tr><td colspan="4">无法加载用户数据</td></tr>';
                }
                return;
            }
            if(panelId === 'user-import'){
                const form = document.getElementById('user-import-form');
                if(form && !form.dataset.bound){
                    form.dataset.bound = '1';
                    form.addEventListener('submit', async (e)=>{
                        e.preventDefault();
                        const file = form.file.files[0];
                        if(!file){ alert('请选择 CSV 文件'); return; }
                        const text = await file.text();
                        const lines = text.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
                        let start = 0;
                        if(lines[0] && (lines[0].includes('name') || lines[0].includes('姓名'))) start = 1;
                        let ok = 0; let fail = 0;
                        for(let i=start;i<lines.length;i++){
                            const parts = lines[i].split(',');
                            const name = (parts[0]||'').trim();
                            const role = (parts[1]||'').trim();
                            if(!name){ fail++; continue; }
                            const payload = { name, role };
                            try{
                                const r = await fetch(API_BASE + '/api/users', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
                                if(!r.ok) { fail++; continue; }
                                ok++;
                            }catch(err){ fail++; }
                        }
                        alert(`导入完成：成功 ${ok}，失败 ${fail}`);
                        form.reset();
                        hideSubPanel();
                    });
                }
                return;
            }
            if(panelId === 'user-roles' || panelId === 'user-permissions' || panelId === 'user-login-logs' || panelId === 'user-login-settings'){
                try{
                    const r = await fetch(API_BASE + '/api/users', {cache:'no-store'});
                    const users = await r.json();
                    const tbody = document.getElementById('panel-users-body');
                    if(!tbody) return;
                    tbody.innerHTML = users.map(u=>`<tr><td>${u.id}</td><td>${u.name}</td><td>${u.role||'-'}</td></tr>`).join('');
                }catch(e){
                    const tbody = document.getElementById('panel-users-body');
                    if(tbody) tbody.innerHTML = '<tr><td colspan="3">无法加载用户数据</td></tr>';
                }
                return;
            }
            if(panelId === 'finance-report' || panelId === 'finance-approve-list' || panelId === 'finance-analysis' || panelId === 'finance-import' || panelId === 'finance-flow-settings'){
                try{
                    const r = await fetch(API_BASE + '/api/finance/transactions', {cache:'no-store'});
                    const tx = await r.json();
                    const tbody = document.getElementById('panel-finance-body');
                    if(!tbody) return;
                    tbody.innerHTML = tx.map(t=>`<tr><td>${t.time||'-'}</td><td>${t.desc}</td><td>${t.amount}</td></tr>`).join('');
                }catch(e){
                    const tbody = document.getElementById('panel-finance-body');
                    if(tbody) tbody.innerHTML = '<tr><td colspan="3">无法加载财务数据</td></tr>';
                }
                return;
            }
            if(panelId === 'warning-list' || panelId === 'warning-handle-log' || panelId === 'warning-monitor' || panelId === 'warning-handle' || panelId === 'warning-stats' || panelId === 'warning-notify-log' || panelId === 'warning-assign'){
                try{
                    const r = await fetch(API_BASE + '/api/warnings/events', {cache:'no-store'});
                    const items = await r.json();
                    const tbody = document.getElementById('panel-warning-body');
                    if(!tbody) return;
                    tbody.innerHTML = items.map(w=>`<tr><td>${w.title}</td><td>${w.msg||''}</td><td>${w.severity||'-'}</td><td>${w.status||'-'}</td></tr>`).join('');
                }catch(e){
                    const tbody = document.getElementById('panel-warning-body');
                    if(tbody) tbody.innerHTML = '<tr><td colspan="4">无法加载预警数据</td></tr>';
                }
                return;
            }
            if(panelId === 'finance-add'){
                const form = document.getElementById('finance-add-form');
                if(form){
                    form.addEventListener('submit', async (e)=>{
                        e.preventDefault();
                        const payload = { desc: form.desc.value, amount: Number(form.amount.value) };
                        try{
                            const r = await fetch(API_BASE + '/api/finance/transactions', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
                            if(!r.ok) throw new Error('提交失败');
                            alert('提交成功');
                            hideSubPanel();
                        }catch(err){ alert('提交失败'); }
                    }, { once: true });
                }
                return;
            }
            if(panelId === 'warning-rules-create'){
                const form = document.getElementById('warning-rule-form');
                if(form){
                    form.addEventListener('submit', async (e)=>{
                        e.preventDefault();
                        const payload = { rule: form.rule.value };
                        try{
                            const r = await fetch(API_BASE + '/api/warnings/rules', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
                            if(!r.ok) throw new Error('提交失败');
                            alert('提交成功');
                            hideSubPanel();
                        }catch(err){ alert('提交失败'); }
                    }, { once: true });
                }
                return;
            }
            if(panelId.startsWith('industry-')){
                try{
                    const r = await fetch(API_BASE + '/api/industry/metrics', {cache:'no-store'});
                    const items = await r.json();
                    const tbody = document.getElementById('panel-industry-body');
                    if(!tbody) return;
                    tbody.innerHTML = items.map(m=>`<tr><td>${m.name}</td><td>${m.value}</td><td>${m.unit||'-'}</td><td>${m.updated_at||'-'}</td><td><button class="btn btn-secondary" data-action="edit" data-id="${m.id}">编辑</button> <button class="btn btn-secondary" data-action="delete" data-id="${m.id}">删除</button></td></tr>`).join('');
                    const table = tbody.closest('table');
                    if(table && !table.dataset.bound){
                        table.dataset.bound = '1';
                        table.addEventListener('click', async (e)=>{
                            const btn = e.target.closest('button[data-action]');
                            if(!btn) return;
                            const id = btn.getAttribute('data-id');
                            const action = btn.getAttribute('data-action');
                            if(action === 'delete'){
                                if(!confirm('确认删除该指标吗？')) return;
                                const r = await fetch(API_BASE + '/api/industry/metrics/' + id, {method:'DELETE'});
                                if(!r.ok){ alert('删除失败'); return; }
                                showSubPanel(panelId);
                            }
                            if(action === 'edit'){
                                const name = prompt('请输入指标名称', btn.closest('tr').children[0].textContent);
                                if(name===null) return;
                                const value = prompt('请输入数值', btn.closest('tr').children[1].textContent);
                                if(value===null) return;
                                const unit = prompt('请输入单位', btn.closest('tr').children[2].textContent);
                                const payload = { name, value, unit };
                                const r = await fetch(API_BASE + '/api/industry/metrics/' + id, {method:'PUT', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
                                if(!r.ok){ alert('更新失败'); return; }
                                showSubPanel(panelId);
                            }
                        });
                    }
                    const form = document.getElementById('industry-add-form');
                    if(form && !form.dataset.bound){
                        form.dataset.bound = '1';
                        form.addEventListener('submit', async (e)=>{
                            e.preventDefault();
                            const payload = { name: form.name.value, value: Number(form.value.value), unit: form.unit.value };
                            const r = await fetch(API_BASE + '/api/industry/metrics', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
                            if(!r.ok){ alert('新增失败'); return; }
                            form.reset();
                            showSubPanel(panelId);
                        });
                    }
                }catch(e){
                    const tbody = document.getElementById('panel-industry-body');
                    if(tbody) tbody.innerHTML = '<tr><td colspan="5">无法加载产业数据</td></tr>';
                }
                return;
            }
            if(panelId.startsWith('ai-')){
                if(panelId === 'ai-qa-log'){
                    try{
                        const r = await fetch(API_BASE + '/api/ai/records?type=chat', {cache:'no-store'});
                        const items = await r.json();
                        const tbody = document.getElementById('panel-ai-body');
                        if(tbody) tbody.innerHTML = items.map(a=>`<tr><td>${a.question}</td><td>${a.answer||''}</td><td>${a.created_at||'-'}</td></tr>`).join('');
                    }catch(e){
                        const tbody = document.getElementById('panel-ai-body');
                        if(tbody) tbody.innerHTML = '<tr><td colspan="3">无法加载问答记录</td></tr>';
                    }
                }
                if(panelId === 'ai-advice-log'){
                    try{
                        const r = await fetch(API_BASE + '/api/ai/records?type=advice', {cache:'no-store'});
                        const items = await r.json();
                        const tbody = document.getElementById('panel-ai-body');
                        if(tbody) tbody.innerHTML = items.map(a=>`<tr><td>${a.question}</td><td>${a.answer||''}</td><td>${a.created_at||'-'}</td></tr>`).join('');
                    }catch(e){
                        const tbody = document.getElementById('panel-ai-body');
                        if(tbody) tbody.innerHTML = '<tr><td colspan="3">无法加载建议历史</td></tr>';
                    }
                }
                if(panelId === 'ai-qa'){
                    const chat = document.getElementById('ai-chat');
                    if(chat && !chat.dataset.bound){
                        chat.dataset.bound = '1';
                        chat.innerHTML = '';
                    }
                    const form = document.getElementById('ai-chat-form');
                    if(form && !form.dataset.bound){
                        form.dataset.bound = '1';
                        form.addEventListener('submit', async (e)=>{
                            e.preventDefault();
                            const q = form.question.value.trim();
                            if(!q) return;
                            const userMsg = document.createElement('div');
                            userMsg.className = 'card';
                            userMsg.style.marginBottom = '8px';
                            userMsg.innerHTML = `<strong>你：</strong> ${q}`;
                            chat.appendChild(userMsg);
                            form.question.value = '';
                            try{
                                const r = await fetch(API_BASE + '/api/ai/ask', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({question: q})});
                                if(!r.ok) throw new Error('提交失败');
                                const data = await r.json();
                                const aiMsg = document.createElement('div');
                                aiMsg.className = 'card';
                                aiMsg.style.marginBottom = '8px';
                                aiMsg.innerHTML = `<strong>AI：</strong> ${data.answer||''}`;
                                chat.appendChild(aiMsg);
                                chat.scrollTop = chat.scrollHeight;
                            }catch(err){
                                const errMsg = document.createElement('div');
                                errMsg.className = 'card';
                                errMsg.style.marginBottom = '8px';
                                errMsg.innerHTML = `<strong>AI：</strong> 请求失败`;
                                chat.appendChild(errMsg);
                            }
                        });
                    }
                }
                if(panelId === 'ai-doc'){
                    const form = document.getElementById('ai-summary-form');
                    const result = document.getElementById('ai-summary-result');
                    if(form && !form.dataset.bound){
                        form.dataset.bound = '1';
                        form.addEventListener('submit', async (e)=>{
                            e.preventDefault();
                            const content = form.content.value.trim();
                            if(!content) return;
                            try{
                                const r = await fetch(API_BASE + '/api/ai/summarize', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify({content})});
                                if(!r.ok) throw new Error('提交失败');
                                const data = await r.json();
                                result.style.display = 'block';
                                result.innerHTML = `<strong>摘要：</strong><div class="muted" style="margin-top:6px;">${data.summary||''}</div>`;
                            }catch(err){
                                result.style.display = 'block';
                                result.innerHTML = `<strong>摘要：</strong><div class="muted" style="margin-top:6px;">生成失败</div>`;
                            }
                        });
                    }
                }
                if(panelId === 'ai-advice'){
                    try{
                        const r = await fetch(API_BASE + '/api/industry/metrics', {cache:'no-store'});
                        const items = await r.json();
                        const tbody = document.getElementById('panel-ai-advice-body');
                        if(tbody) tbody.innerHTML = items.map(m=>`<tr><td>${m.name}</td><td>${m.value}</td><td>${m.unit||'-'}</td></tr>`).join('');
                        const suggestionEl = document.getElementById('ai-advice-result');
                        if(suggestionEl){
                            const top = items[0];
                            let advice = '建议：聚焦产业基础数据，完善产销协同。';
                            if(top){
                                advice = `建议：围绕“${top.name}”提升质量与品牌，扩大市场覆盖，并推动数字化管理。`;
                            }
                            suggestionEl.innerHTML = `<strong>发展方向：</strong><div class="muted" style="margin-top:6px;">${advice}</div>`;
                            const saveBtn = document.getElementById('ai-advice-save');
                            if(saveBtn && !saveBtn.dataset.bound){
                                saveBtn.dataset.bound = '1';
                                saveBtn.addEventListener('click', async ()=>{
                                    try{
                                        const payload = { type: 'advice', question: '发展方向', answer: advice };
                                        const rr = await fetch(API_BASE + '/api/ai/records', {method:'POST', headers:{'content-type':'application/json'}, body: JSON.stringify(payload)});
                                        if(!rr.ok) throw new Error('保存失败');
                                        alert('已保存到建议历史');
                                    }catch(e){
                                        alert('保存失败');
                                    }
                                });
                            }
                        }
                    }catch(e){
                        const suggestionEl = document.getElementById('ai-advice-result');
                        if(suggestionEl) suggestionEl.innerHTML = '<strong>发展方向：</strong><div class="muted" style="margin-top:6px;">无法获取产业数据</div>';
                    }
                }
                return;
            }
            if(panelId.startsWith('ops-')){
                try{
                    const r = await fetch(API_BASE + '/api/ops/audit', {cache:'no-store'});
                    const items = await r.json();
                    const tbody = document.getElementById('panel-ops-body');
                    if(tbody) tbody.innerHTML = items.map(o=>`<tr><td>${o.action}</td><td>${o.actor}</td><td>${o.status}</td><td>${o.created_at||'-'}</td></tr>`).join('');
                }catch(e){
                    const tbody = document.getElementById('panel-ops-body');
                    if(tbody) tbody.innerHTML = '<tr><td colspan="4">无法加载运维数据</td></tr>';
                }
                return;
            }
        }

        // 关闭按钮与遮罩
        document.getElementById('sub-panel-close').addEventListener('click', hideSubPanel);
        document.getElementById('sub-panel-overlay').addEventListener('click', hideSubPanel);
        document.addEventListener('keydown', function(e){ if(e.key === 'Escape') hideSubPanel(); });
        
        setInterval(updateTime, 1000);
        updateTime();
    </script>
</body>
</html>